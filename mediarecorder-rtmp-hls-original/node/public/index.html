<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MediaRecorder Streaming</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    video { width: 100%; max-width: 600px; margin-top: 20px; display: none; }
  </style>
</head>
<body>
  <h1>Start Streaming</h1>
  <button onclick="startCamera()">Use Camera</button>
  <button onclick="startScreen()">Share Screen</button>
  <button onclick="playFile()">Upload Video</button>
  <button onclick="stopStreaming()">Stop</button>
  <video id="preview" controls autoplay></video>

  <script>
    let ws, recorder;
    const preview = document.getElementById('preview');

    function setupRecorder(stream) {
      ws = new WebSocket('wss://anthena.i.ng/ws?streamKey=stream_demo&token=YOUR_SECRET');

      ws.onopen = () => {
        console.log('WebSocket opened, now starting MediaRecorder...');

        console.log(MediaRecorder.isTypeSupported('video/webm; codecs=vp8'));
        recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });
        console.log('MediaRecorder created:', recorder.mimeType);

        recorder.ondataavailable = e => {
          console.log('ondataavailable fired');
          if (e.data.size > 0 && ws.readyState === 1) {
            console.log('Sending chunk:', e.data.size);
            ws.send(e.data);
          } else {
            console.log('Not sending chunk – WebSocket not ready or empty');
          }
        };

        recorder.onstart = () => console.log('MediaRecorder started');

        try {
          recorder.start(100);// send chunks every 100ms
          console.log('MediaRecorder.start() called');
        } catch (err) {
          console.error('MediaRecorder start failed:', err);
        }

        recorder.onerror = err => console.error('MediaRecorder error:', err);
        preview.srcObject = stream;
        preview.style.display = 'block';

        setInterval(() => {
          if (recorder) console.log('Recorder state:', recorder.state);
        }, 1000);
      };

      ws.onerror = err => {
        console.error('WebSocket error:', err);
      };

      ws.onclose = () => {
        console.warn('WebSocket closed unexpectedly');
      };
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        console.log('📷 Camera stream tracks:', stream.getTracks().map(t => t.kind));
        setupRecorder(stream);
      } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Error accessing camera. Please check your permissions.');
      }
    }

    async function startScreen() {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        console.log('🖥️ Screen share stream tracks:', stream.getTracks().map(t => t.kind));
        setupRecorder(stream);
        stream.getVideoTracks()[0].addEventListener('ended', () => {
          console.log('Screen sharing stopped by user.');
          stopStreaming();
        });
      } catch (error) {
        console.error('Error accessing screen share:', error);
        alert('Error accessing screen share. Please check your permissions.');
      }
    }

    function playFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'video/*';
      input.onchange = () => {
        const file = input.files[0];
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.style.display = 'block';

        preview.onloadedmetadata = () => {
          console.log('🎞 Video loaded:', preview.duration);
          // Ensure the video is loaded before capturing the stream
          preview.play().then(() => {
            console.log('🎬 Video started playing');
            const stream = preview.captureStream();
            console.log('📡 Captured stream:', stream, 'Tracks:', stream.getTracks());
            setupRecorder(stream);
          }).catch(error => {
            console.error('Error playing video:', error);
            alert('Error playing the selected video.');
          });
        };

        preview.onerror = (error) => {
          console.error('Error loading video:', error);
          alert('Error loading the selected video.');
        };
      };
      input.click();
    }

    function stopStreaming() {
      if (recorder && recorder.state !== 'inactive') {
        recorder.stop();
      }
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
      if (preview.srcObject) {
        const tracks = preview.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        preview.srcObject = null;
      } else if (preview.src) {
        preview.pause();
        preview.removeAttribute('src');
        preview.load();
      }
      console.log('Stream stopped.');
      alert('Stream stopped.');
    }
  </script>
</body>
</html>